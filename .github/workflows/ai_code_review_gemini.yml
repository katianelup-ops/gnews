name: Gemini AI Code Reviewer

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini_review:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Comment on PR using Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # 1. Pega o DIFF
          DIFF=$(curl -sS -L \
            -H "Authorization: Bearer $GITHUB_TOKEN"\
            -H "Accept: application/vnd.github.v3.diff"\
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER")

          # 2. Monta o JSON para o Gemini
          BODY=$(jq -n --arg d "$(echo "$DIFF" | head -c 12000)" '{
            contents: [{role:"user", parts:[{text:("Analise o diff e aponte vulnerabilidades reais (SQLi, XSS, etc). Diff:\n" + $d)}]}],
            generationConfig:{temperature:0.2,maxOutputTokens:500}
          }')

          # 3. Chamada para a API (Formato ALTERNATIVO)
          RESP=$(curl -sS -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent"\
            -H "Content-Type: application/json"\
            -H "x-goog-api-key: $GEMINI_API_KEY"\
            -d "$BODY")

          # 4. Extrai texto
          TEXT=$(echo "$RESP" | jq -r '(.candidates[0].content.parts // []) | map(.text // empty) | join("\n")')

          # 5. Fallback se vier vazio
          if [ -z "${TEXT// }" ]; then
            BLOCK_REASON=$(echo "$RESP" | jq -r '.promptFeedback.blockReason // empty')
            FINISH_REASON=$(echo "$RESP" | jq -r '.candidates[0].finishReason // empty')
            ERR_MSG=$(echo "$RESP" | jq -r '.error.message // empty')

            TEXT="(Resposta vazia do Gemini)\nblockReason=${BLOCK_REASON}\nfinishReason=${FINISH_REASON}\nerror=${ERR_MSG}"
          fi

          # 6. Posta o comentÃ¡rio
          curl -sS -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN"\
            -H "Accept: application/vnd.github+json"\
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"\
            -d "$(jq -n --arg body "ðŸ¤– Gemini:\n\n$TEXT" '{body:$body}')"
