name: Gemini AI Code Reviewer

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Review PR diff with Gemini and comment on PR
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          echo "Fetching diff for PR #$PR_NUMBER ..."
          DIFF="$(curl -sS -L \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3.diff" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER")"

          # Limita tamanho
          DIFF_TRUNC="$(echo "$DIFF" | head -c 12000)"

          PROMPT="Voc√™ √© um revisor de c√≥digo focado em seguran√ßa.
Analise APENAS o diff abaixo e identifique vulnerabilidades reais (principalmente SQL Injection, XSS, Command Injection, SSRF, Hardcoded secrets).
Se encontrar algo, explique:
1) Onde est√° (arquivo/trecho)
2) Por que √© vulnerabilidade
3) Como explorar (em alto n√≠vel)
4) Como corrigir (com exemplo de c√≥digo seguro)
Se n√£o encontrar, diga: Nenhuma vulnerabilidade clara encontrada no diff.

DIFF:"

          BODY="$(jq -n --arg p "$PROMPT" --arg d "$DIFF_TRUNC" '{
            contents: [
              { role: "user", parts: [ { text: ($p + "\n" + $d) } ] }
            ],
            generationConfig: { temperature: 0.2, maxOutputTokens: 700 }
          }')"

          echo "Calling Gemini..."
          RESP="$(curl -sS -X POST \
            -H "Content-Type: application/json" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -d "$BODY")"

          TEXT="$(echo "$RESP" | jq -r '.candidates[0].content.parts[0].text // empty')"

          if [ -z "$TEXT" ]; then
            echo "Gemini returned empty response. Full response:"
            echo "$RESP"
            exit 1
          fi

          echo "Posting comment to PR..."
          curl -sS -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d "$(jq -n --arg body "ü§ñ **Gemini AI Code Review (Seguran√ßa)**\n\n$TEXT" '{body:$body}')"

          echo "Done."
